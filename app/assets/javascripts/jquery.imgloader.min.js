/*! jQuery.ImgLoader - v0.2.0 -  12/2/2012
 * https://github.com/Takazudo/jQuery.ImgLoader
 * Copyright (c) 2012 "Takazudo" Takeshi Takatsudo; Licensed MIT */// Generated by CoffeeScript 1.4.0
(function(){var e=[].slice,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};(function(t,r,i){var s,o;return s=t.ImgLoaderNs={},s.support={},s.support.xhr2=r.FormData!=null,s.createCachedFunction=function(e){var n;return n={},function(r,i){return n[r]||(n[r]=t.Deferred(function(t){return e(t,r,i)}).promise()),n[r]}},s.fetchImg=s.createCachedFunction(function(e,n,r){var i,o,u,a;return u=new Image,o=function(){return u.onload=u.onerror=null},e.always(o),i=t(u),u.onload=function(){return e.resolve(i)},u.onerror=function(){return e.reject(i)},s.support.xhr2&&(r!=null?r.useXHR2:void 0)?(a=new s.Xhr2Request(n,{timeout:r.timeout}),e.xhr=a,a.on("progress",function(){return e.notify(a.currentLoadedInfo())}),a.on("loadend timeout",function(){return u.src=n}),a.send()):u.src=n}),function(){var e;return e={},s.loadImg=function(n,r,i){return t.Deferred(function(t){return s.fetchImg(n,{useXHR2:r,timeout:i}).progress(function(e){return t.notify(e)}).then(function(r){var i,s;return e[n]||(e[n]=r),i=e[n],s=i.clone(),e[n]=s,t.resolve(i)},function(e){return t.reject(e)})}).promise()}}(),o=function(e){return t.Deferred(function(t){return setTimeout(function(){return t.resolve()},e)})},s.Event=function(){function t(){this._callbacks={}}return t.prototype.on=function(e,t){var n,r,i,s,o;n=e.split(" ");for(s=0,o=n.length;s<o;s++)r=n[s],(i=this._callbacks)[r]||(i[r]=[]),this._callbacks[r].push(t);return this},t.prototype.one=function(e,t){return this.on(e,function(){return this.off(e,arguments.callee),t.apply(this,arguments)})},t.prototype.trigger=function(){var t,n,r,i,s,o,u;t=1<=arguments.length?e.call(arguments,0):[],r=t.shift(),i=(u=this._callbacks)!=null?u[r]:void 0;if(!i)return;for(s=0,o=i.length;s<o;s++){n=i[s];if(n.apply(this,t)===!1)break}return this},t.prototype.off=function(e,t){var n,r,i,s,o,u;if(!e)return this._callbacks={},this;i=(u=this._callbacks)!=null?u[e]:void 0;if(!i)return this;if(!t)return delete this._callbacks[e],this;for(r=s=0,o=i.length;s<o;r=++s){n=i[r];if(n!==t)continue;i=i.slice(),i.splice(r,1),this._callbacks[e]=i;break}return this},t.prototype.bind=function(){return this.on.apply(this,arguments)},t.prototype.unbind=function(){return this.off.apply(this,arguments)},t}(),s.Xhr2Request=function(e){function r(e,n){this.url=e,r.__super__.constructor.apply(this,arguments),this.options=t.extend({timeout:1e4},n),this._prepare()}return n(r,e),r.prototype._prepare=function(){var e,t=this;return e=!1,this._request=new XMLHttpRequest,this._request.open("GET",this.url),this._request.timeout=this.options.timeout,this._request.onloadend=function(){return t.trigger("loadend")},this._request.onprogress=function(n){return e||(e=!0,t.totalSize=n.totalSize,t.trigger("firstprogress")),t.loadedSize=n.loaded,t.loadedRatio=t.loadedSize/t.totalSize,t.trigger("progress")},this._request.ontimeout=function(){return t.options.timeout},this},r.prototype.currentLoadedInfo=function(){return{totalSize:this.totalSize,loadedSize:this.loadedSize,loadedRatio:this.loadedRatio}},r.prototype.send=function(){return this._request.send(),this},r}(s.Event),s.LoaderItem=function(e){function r(e,t,n){this.src=e,this._useXHR2=t!=null?t:!0,this._timeout=n!=null?n:1e4,r.__super__.constructor.apply(this,arguments)}return n(r,e),r.prototype.load=function(){var e=this;return t.Deferred(function(t){return s.loadImg(e.src,e._useXHR2,e._timeout).progress(function(t){return e.trigger("progress",t)}).then(function(n){return e.$img=n,e.trigger("success",e.$img),e.trigger("complete",e.$img),t.resolve(e.$img)},function(n){return e.$img=n,e.trigger("error",e.$img),e.trigger("complete",e.$img),t.reject(e.$img)})})},r}(s.Event),s.AbstractLoader=function(e){function t(){t.__super__.constructor.apply(this,arguments)}return n(t,e),t.prototype._prepareProgressInfo=function(){var e,t,n;return e=this.items||this._presets,t=e.length,this.progressInfo=n={loadedFileCount:0,totalFileCount:t,loadedRatio:0},this.ratioPerItem=1/t,this},t.prototype._updateProgressInfo=function(e,t){var n,r;return r=this.progressInfo,n=t.loadedRatio*this.ratioPerItem,r.loadedRatio=r.loadedRatio+n-(e.lastLoadedRatio||0),r.loadedRatio>1&&(r.loadedRatio=1),e.lastLoadedRatio=n,this},t}(s.Event),s.BasicLoader=function(r){function i(e,t){this._useXHR2=e!=null?e:!0,this._timeout=t!=null?t:1e4,i.__super__.constructor.apply(this,arguments),this.items=[]}return n(i,r),i.prototype.add=function(e){var n;return t.type(e)==="string"&&(n=e,e=new s.LoaderItem(n,this._useXHR2,this._timeout)),this.items.push(e),e},i.prototype.load=function(){var n,r,i=this;return this._prepareProgressInfo(),r=this.progressInfo,n=t.map(this.items,function(e){return e.on("progress",function(t){return i._updateProgressInfo(e,t),i.trigger("progress",r)}),e.on("complete",function(e){r.loadedFileCount+=1;if(!s.support.xhr2||!i._useXHR2)r.loadedRatio=r.loadedFileCount/r.totalFileCount,i.trigger("progress",r);return i.trigger("itemload",e,r)}),e.load()}),t.Deferred(function(s){return t.when.apply(i,n).always(function(){var n,o;return o=1<=arguments.length?e.call(arguments,0):[],n=t(o),r.loadedRatio=1,i.trigger("progress",r),i.trigger("allload",n,r),s.resolve(n,r)})}).promise()},i.prototype.kill=function(){var e,t,n,r;r=this.items;for(t=0,n=r.length;t<n;t++)e=r[t],e.off();return this.trigger("kill"),this.off(),this},i}(s.AbstractLoader),s.ChainLoader=function(e){function r(e,n,i,s){this._pipesize=e,this._delay=n!=null?n:0,this._useXHR2=i,this._timeout=s,r.__super__.constructor.apply(this,arguments),this._presets=[],this._inLoadCount=0,this._allDoneDefer=t.Deferred()}return n(r,e),r.prototype._finished=function(){return this.progressInfo.loadedFileCount===this._presets.length},r.prototype._nextLoadAllowed=function(){return this._inLoadCount<this._pipesize},r.prototype._getImgs=function(){return t(t.map(this._presets,function(e){return e.item.$img}))},r.prototype._handleNext=function(){var e,n,r=this;return n=this.progressInfo,this._finished()?this._allloadFired?this:(this._allloadFired=!0,e=this._getImgs(),this.trigger("progress",n),this.trigger("allload",e,n),this._allDoneDefer.resolve(e),this):(t.each(this._presets,function(e,t){var i;return i=t.item,t.started?!0:r._nextLoadAllowed()?(r._inLoadCount+=1,t.started=!0,i.on("progress",function(e){return r._updateProgressInfo(i,e),r.trigger("progress",n)}),i.on("complete",function(i){var u;return t.done=!0,u=function(){n.loadedFileCount+=1,r._inLoadCount-=1;if(!s.support.xhr2||!r._useXHR2)n.loadedRatio=n.loadedFileCount/n.totalFileCount,r.trigger("progress",n);return r.trigger("itemload",i,n),t.defer.resolve(i),o(r._delay).done(function(){return r._handleNext()})},e===0?u():r._presets[e-1].defer.always(function(){return u()})}),i.load()):!1}),this)},r.prototype.add=function(e){var n,r;return t.type(e)==="string"&&(r=e,e=new s.LoaderItem(r,this._useXHR2,this._timeout)),n={item:e,done:!1,started:!1,defer:t.Deferred()},this._presets.push(n),n.defer},r.prototype.load=function(){return this._prepareProgressInfo(),this._handleNext(),this._allDoneDefer},r.prototype.kill=function(){var e,t,n,r;r=this._presets;for(t=0,n=r.length;t<n;t++)e=r[t],e.item.off();return this.trigger("kill"),this.off(),this},r}(s.AbstractLoader),s.LoaderFacade=function(){function f(e){var n,r,i,o,u;if(!(this instanceof arguments.callee))return new s.LoaderFacade(e);this.options=n=t.extend({srcs:[],pipesize:0,delay:100,timeout:1e4,useXHR2:!0},e),n.pipesize?this.loader=new s.ChainLoader(n.pipesize,n.delay,n.useXHR2,n.timeout):this.loader=new s.BasicLoader(n.useXHR2,n.timeout),u=n.srcs;for(i=0,o=u.length;i<o;i++)r=u[i],this.loader.add(r)}var n,r,i,o,u,a=this;r=["bind","trigger","on","off","load","one","unbind","add","kill"],i=function(t){return f.prototype[t]=function(){var n;return n=1<=arguments.length?e.call(arguments,0):[],this.loader[t].apply(this.loader,n)}};for(o=0,u=r.length;o<u;o++)n=r[o],i(n);return f}.call(this),function(){var e,n,r,i,u;return r={},e=null,n=function(){return t.Deferred(function(n){return t(function(){return e=t('<div id="calcNaturalWH-tempholder"></div>').css({position:"absolute",left:"-9999px",top:"-9999px"}),t("body").append(e),n.resolve()})}).promise()},i=function(e){return e.naturalWidth==null||e.naturalWidth===0||e.naturalHeight==null||e.naturalHeight===0?!1:!0},u=function(n,i){var s;return n=n.clone(),s=n[0],t.Deferred(function(u){var a,f,l,c;return c={},n.css({width:"auto",height:"auto"}),a=t("<div></div>").append(n),e.append(a),f=0,l=function(){return c.width=s.naturalWidth||n.width(),c.height=s.naturalHeight||n.height(),f>10?(a.remove(),u.reject()):!c.width||!c.height?(f++,o(100).done(function(){return l()})):(r[i],a.remove(),u.resolve(c))},l()}).promise()},s.calcNaturalWH=s.createCachedFunction(function(e,t){return s.loadImg(t).then(function(s){var o,a;return o=s[0],i(o)?(a={width:o.naturalWidth,height:o.naturalHeight},r[t]=a,e.resolve(a,s)):n().done(function(){return u(s,t).then(function(t){return e.resolve(t,s)},function(){return e.reject()})})},function(){return e.reject()})})}(),t.loadImg=s.loadImg,t.ImgLoader=s.LoaderFacade,t.calcNaturalWH=s.calcNaturalWH})(jQuery,this,this.document)}).call(this);